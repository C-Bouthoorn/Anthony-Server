// Generated by CoffeeScript 1.10.0
/*jshint jquery: true*///;
/*globals io:false, console:false *///;
'use strict';
var init, initchat, login, register, safe, sessionid, setstatus, socket;

socket = null;

sessionid = null;

setstatus = function(stat, subscr, iserror) {
  var elem, html;
  if (typeof subscr !== 'string') {
    iserror = subscr;
    subscr = '';
  }
  elem = $('#connstatus');
  html = stat + '<br><small>' + subscr + '</small>';
  elem.html(html);
  if (iserror) {
    return elem.addClass('error');
  } else {
    return elem.removeClass('error');
  }
};

safe = function(callback) {
  var err, error;
  try {
    return callback();
  } catch (error) {
    err = error;
    console.log(err);
    return setstatus(err.message, true);
  }
};

init = function() {
  return safe(function() {
    socket = io.connect();
    socket.on('connect', function() {
      return setstatus('Connected to the server!');
    });
    socket.on('setid', function(data) {
      return sessionid = data.sessionid;
    });
    socket.on('disconnect', function() {
      return setstatus('Lost connection!', true);
    });
    $('#password').keyup(function(event) {
      if (event.keyCode === 13) {
        return $('#btn').click();
      }
    });
    socket.on('login-complete', function(data) {
      setstatus("Welcome " + username + "!", 'Loading chat...');
      return initchat();
    });
    socket.on('login-failed', function(data) {
      return setstatus('Failed to login:', data.error, true);
    });
    socket.on('register-complete', function(data) {
      return setstatus("Welcome to our server, " + username + " !");
    });
    return socket.on('register-failed', function(data) {
      return setstatus('Failed to register', data.error, true);
    });
  });
};

initchat = function() {
  socket.on('disconnect', function() {
    if ($('#msgbox') == null) {
      return alert('Disconnected from server!');
    }
  });
  socket.on('chat-data', function(data) {
    var html;
    html = data.html;
    $('body').html(html);
    socket.on('disconnect', function() {
      var msgbox;
      msgbox = $('#msgbox');
      msgbox.prop('disabled', true);
      msgbox.css('background-color', '#333');
      if ($('#refreshlink')[0] === void 0) {
        msgbox.parent().append("<span id=\"refreshlink\" class=\"error\">Lost connection\n<a href style=\"display: none;\" onclick=\"location.href=location.href\"> Try refreshing?</a></span>");
      }
      socket.on('connect', function() {
        return $('#refreshlink a').show();
      });
      return socket.on('disconnect', function() {
        return $('#refreshlink a').hide();
      });
    });
    $('#msgbox').keyup(function(event) {
      var message;
      if (event.keyCode === 13) {
        message = $('#msgbox').val();
        $('#msgbox').val('');
        return socket.emit('client-send-message', {
          sessionid: sessionid,
          message: message
        });
      }
    });
    return socket.on('client-receive-message', function(data) {
      var message, user;
      user = data.user;
      message = data.message;
      html = "<p class='chat-message " + user.type + "'>";
      if (user.name !== "SERVER") {
        html += "<span class='user'>" + user.name + ": </span>";
      }
      html += message + "</p>";
      return $('#chatbox').html(html + $('#chatbox').html());
    });
  });
  return socket.emit('get-chat-data', {});
};

login = function() {
  return safe(function() {
    var password, username;
    username = $('#username').val();
    password = $('#password').val();
    return socket.emit('login', {
      username: username,
      password: password
    });
  });
};

register = function() {
  return safe(function() {
    var password, username;
    username = $('#username').val();
    password = $('#password').val();
    return socket.emit('register', {
      username: username,
      password: password
    });
  });
};
