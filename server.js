// Generated by CoffeeScript 1.10.0
'use strict';
var Base64, FILES, PORT, SERVER_USER, USER_TABLE, WWW_ROOT, app, db, fs, http, io, mysql, password, postlogin, sendMessage, sessionid_by_socketid, sessions, sockets, util,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

app = require('express')();

http = require('http').Server(app);

io = require('socket.io')(http);

mysql = require('mysql');

password = require('password-hash-and-salt');

fs = require('fs');

util = require('util');

Base64 = {
  encode: function(x) {
    return new Buffer(x).toString('base64');
  },
  decode: function(x) {
    return new Buffer(x, 'base64').toString('utf8');
  }
};

PORT = 3000;

db = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'chat_dev'
});

USER_TABLE = 'users_dev';

db.connect();

Object.prototype.map = function(callback) {
  var k, results, v;
  results = [];
  for (k in this) {
    if (Object.hasOwnProperty.call(this, k)) {
      v = this[k];
      results.push(callback(k, v));
    } else {
      results.push(void 0);
    }
  }
  return results;
};

FILES = {
  root: ['/index.html', '/index.js', '/index.css', '/login.html', '/register.html'],
  redir: {
    '/': '/index.html',
    '/login': '/login.html',
    '/register': '/register.html'
  }
};

WWW_ROOT = __dirname + '/www';

FILES.root.map(function(file) {
  return app.get(file, function(req, res) {
    return res.sendFile(WWW_ROOT + file);
  });
});

FILES.redir.map(function(file, dest) {
  return app.get(file, function(req, res) {
    return res.sendFile(WWW_ROOT + dest);
  });
});

sockets = {};

sessions = {};

sessionid_by_socketid = {};

SERVER_USER = {
  name: 'SERVER',
  type: 'server'
};

sendMessage = function(user, message) {
  var i, len, ref, results, s, socketid;
  ref = Object.keys(sockets);
  results = [];
  for (i = 0, len = ref.length; i < len; i++) {
    socketid = ref[i];
    s = sockets[socketid];
    results.push(s.emit('client-receive-message', {
      user: user,
      message: message
    }));
  }
  return results;
};

postlogin = function(socket, user) {
  var sessionid, socketid;
  socketid = socket.conn.id;
  sessionid = "";
  while (sessionid === "" || sessions[sessionid] !== void 0) {
    sessionid = Base64.encode("" + (Math.random() * 1e10));
  }
  console.log("Created sessionid '" + sessionid + "'");
  sessions[sessionid] = {
    user: user
  };
  socket.emit('setid', {
    sessionid: sessionid
  });
  if (!(indexOf.call(sockets, socketid) >= 0)) {
    sockets[socketid] = socket;
  }
  sessionid_by_socketid[socketid] = sessionid;
  socket.on('get-chat-data', function() {
    return fs.readFile(WWW_ROOT + "/chatbox.html", function(err, data) {
      if (err) {
        data = "<h4 class='error'>Failed to get chatbox data</h4>";
      }
      data = '' + data;
      return socket.emit('chat-data', {
        html: data
      });
    });
  });
  socket.emit('login-complete', {});
  return sendMessage(SERVER_USER, "<span class='user'>" + user + "</span> joined us! Yay!");
};

io.sockets.on('connection', function(socket) {
  var ip;
  ip = socket.client.conn.remoteAddress;
  if (ip.startsWith("::ffff:")) {
    ip = ip.substring("::ffff:".length);
  }
  if (ip === "127.0.0.1") {
    ip = "localhost";
  }
  console.log("Client connected from " + ip);
  socket.on('register', function(data) {
    if (data === void 0) {
      console.log('No data received');
      socket.emit('register-failed', {
        error: 'No data received'
      });
      return;
    }
    return (function(data) {
      var pass, qq, user;
      user = data.user;
      pass = data.pass;
      if (user === void 0 || pass === void 0) {
        console.log('Username or password undefined!');
        socket.emit('register-failed', {
          error: 'Username or password undefined'
        });
        return;
      }
      if (user.length < 2 || pass.length < 2) {
        console.log('Username or password too short');
        socket.emit('register-failed', {
          error: 'Username or password too short'
        });
        return;
      }
      console.log("Registration request received for user '" + user + "'");
      qq = "SELECT id FROM " + USER_TABLE + " WHERE username = " + (db.escape(user));
      return db.query(qq, function(err, data) {
        if (data.length > 0) {
          console.log("User '" + user + "' already exists");
          socket.emit('register-failed', {
            error: 'Username already exists'
          });
          return;
        }
        return password(pass).hash(function(err, hash) {
          if (err) {
            throw err;
          }
          qq = "INSERT INTO " + USER_TABLE + " (username, password) VALUES (" + (db.escape(user)) + ", " + (db.escape(hash)) + ")";
          return db.query(qq, function(err, data) {
            if (err) {
              throw err;
            }
            console.log("Registration for user '" + user + "' done");
            return socket.emit('register-complete', {
              user: user
            });
          });
        });
      });
    })(data);
  });
  socket.on('login', function(data) {
    if (data === void 0) {
      console.log('No data received');
      socket.emit('login-failed', {
        error: 'No data received'
      });
      return;
    }
    return (function(data) {
      var pass, qq, user;
      user = data.user;
      pass = data.pass;
      if (user === void 0 || pass === void 0) {
        console.log('Username and/or password undefined!');
        socket.emit('login-failed', {
          error: 'Username or password undefined'
        });
        return;
      }
      console.log("Login request received for user '" + user + "'");
      qq = "SELECT password FROM " + USER_TABLE + " WHERE username = " + (db.escape(user));
      return db.query(qq, function(err, data) {
        var hash;
        if (err) {
          throw err;
        }
        if (data.length < 1) {
          console.log("User '" + user + "' not found");
          socket.emit('login-failed', {
            error: 'Username or password incorrect!'
          });
          return;
        }
        hash = data[0].password;
        return password(pass).verifyAgainst(hash, function(err, succes) {
          if (err) {
            throw err;
          }
          if (!succes) {
            console.log("User '" + user + "' failed to login - hashes don't match");
            socket.emit('login-failed', {
              error: 'Username or password incorrect!'
            });
            return;
          }
          console.log("User '" + user + "' succesfully logged in");
          return postlogin(socket, user);
        });
      });
    })(data);
  });
  socket.on('client-send-message', function(data) {
    var message, user;
    if (data === void 0) {
      console.log('No data received');
      return;
    }
    if (data.sessionid === void 0) {
      console.log('No session id received');
      return;
    }
    if (sessions[data.sessionid] === void 0) {
      console.log("Session ID '" + data.sessionid + "' not found in sessions");
      return;
    }
    user = sessions[data.sessionid].user;
    message = data.message;
    if (message === void 0) {
      console.log('No message received');
      return;
    }
    console.log("Got message '" + message + "' from user '" + user + "'");
    return sendMessage({
      name: user,
      type: 'normal'
    }, message);
  });
  return socket.on('disconnect', function() {
    var sessionid, socketid, user;
    socketid = socket.conn.id;
    sessionid = sessionid_by_socketid[socketid];
    if (sessionid !== void 0) {
      user = sessions[sessionid].user;
      console.log(user + " has disconnected");
      return sendMessage(SERVER_USER, user + " has left us ;-;");
    } else {
      return console.log("Non-logged-in client '" + socketid + ":" + sessionid + "' has disconnected");
    }
  });
});

http.listen(PORT, function() {
  return console.log("Server started on port " + PORT);
});
